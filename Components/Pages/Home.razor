@page "/"
@using BlazorTimeZoneHelper.Services
@using BlazorTimeZoneHelper.Models
@inject TimeZoneService TimeZoneService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Time Zone Helper</PageTitle>

<div class="timezone-container">
    <div class="app-header">
        <h1>🌍 World Time Zone Converter</h1>
        <a href="/settings" class="settings-link">⚙️ Settings</a>
    </div>
    
    <div class="controls-section">
        <div class="time-selector">
            <label for="referenceTime">
                <strong>Reference Time (London):</strong>
            </label>
            <input 
                type="time" 
                id="referenceTime" 
                class="form-control time-input"
                value="@selectedTime.ToString("HH:mm")" 
                @onchange="OnTimeChanged" />
            <span class="time-display">@selectedTime.ToString("hh:mm tt")</span>
        </div>

        <div class="working-hours-toggle">
            <label class="checkbox-label">
                <input 
                    type="checkbox" 
                    @bind="highlightWorkingHours" 
                    @bind:after="UpdateTimeZones" />
                <span>Highlight Working Hours (9 AM - 5 PM)</span>
            </label>
        </div>
    </div>

    <div class="legend" style="display: @(highlightWorkingHours ? "flex" : "none")">
        <div class="legend-item">
            <span class="legend-box working-hours"></span>
            <span>Working Hours (9 AM - 5 PM)</span>
        </div>
        <div class="legend-item">
            <span class="legend-box outside-hours"></span>
            <span>Outside Working Hours</span>
        </div>
    </div>

    @if (timeZones.Count == 0)
    {
        <div class="no-timezones-message">
            <p>No timezones selected. <a href="/settings">Go to Settings</a> to select timezones to display.</p>
        </div>
    }
    else
    {
        @switch (displayMode)
        {
            case TimeZoneService.DisplayMode.Grid:
                <div class="timezone-list timezone-grid">
                    @foreach (var tz in timeZones)
                    {
                        <div class="timezone-card @GetCardClass(tz)">
                            <div class="timezone-header">
                                <h3>@tz.DisplayName</h3>
                                @if (highlightWorkingHours)
                                {
                                    <span class="hours-badge @(tz.IsWithinWorkingHours ? "badge-working" : "badge-outside")">
                                        @(tz.IsWithinWorkingHours ? "Working Hours" : "Outside Hours")
                                    </span>
                                }
                            </div>
                            <div class="timezone-time">
                                <div class="time-large">@tz.CurrentTime.ToString("hh:mm tt")</div>
                                <div class="time-details">
                                    @tz.CurrentTime.ToString("dddd, MMMM d, yyyy")
                                </div>
                                <div class="time-offset">
                                    @TimeZoneService.FormatTimeWithOffset(tz.CurrentTime, tz.TimeZoneInfo)
                                </div>
                            </div>
                        </div>
                    }
                </div>
                break;

            case TimeZoneService.DisplayMode.List:
                <div class="timezone-list timezone-table">
                    <div class="list-header">
                        <div class="col-timezone">Time Zone</div>
                        <div class="col-time">Time</div>
                        <div class="col-date">Date</div>
                        <div class="col-offset">UTC Offset</div>
                        @if (highlightWorkingHours)
                        {
                            <div class="col-status">Status</div>
                        }
                    </div>
                    @foreach (var tz in timeZones)
                    {
                        <div class="list-row @GetCardClass(tz)">
                            <div class="col-timezone">@tz.DisplayName</div>
                            <div class="col-time">@tz.CurrentTime.ToString("hh:mm tt")</div>
                            <div class="col-date">@tz.CurrentTime.ToString("ddd, MMM d")</div>
                            <div class="col-offset">@TimeZoneService.FormatTimeWithOffset(tz.CurrentTime, tz.TimeZoneInfo)</div>
                            @if (highlightWorkingHours)
                            {
                                <div class="col-status">
                                    <span class="status-badge @(tz.IsWithinWorkingHours ? "badge-working" : "badge-outside")">
                                        @(tz.IsWithinWorkingHours ? "Working" : "Off Hours")
                                    </span>
                                </div>
                            }
                        </div>
                    }
                </div>
                break;

            case TimeZoneService.DisplayMode.Compact:
                <div class="timezone-list timezone-compact">
                    @foreach (var tz in timeZones)
                    {
                        <div class="compact-row @GetCardClass(tz)">
                            <div class="compact-tz">@tz.DisplayName</div>
                            <div class="compact-time">@tz.CurrentTime.ToString("hh:mm tt")</div>
                            @if (highlightWorkingHours)
                            {
                                <div class="compact-status">
                                    @(tz.IsWithinWorkingHours ? "✓ Working" : "✗ Off")
                                </div>
                            }
                        </div>
                    }
                </div>
                break;
        }
    }
</div>

<style>
    .timezone-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .app-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .app-header h1 {
        color: #2c3e50;
        margin: 0;
    }

    .settings-link {
        padding: 0.5rem 1rem;
        background-color: #e9ecef;
        color: #2c3e50;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .settings-link:hover {
        background-color: #dee2e6;
        color: #0d6efd;
    }

    .controls-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .time-selector {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .time-selector label {
        margin: 0;
    }

    .time-input {
        width: 150px;
        padding: 0.5rem;
        font-size: 1rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }

    .time-display {
        font-size: 1.1rem;
        color: #495057;
        font-weight: 500;
    }

    .working-hours-toggle {
        display: flex;
        align-items: center;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        margin: 0;
        font-weight: 500;
    }

    .checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .legend {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #fff;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .legend-box {
        width: 30px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .legend-box.working-hours {
        background-color: #cfe2ff;
    }

    .legend-box.outside-hours {
        background-color: #f8d7da;
    }

    .no-timezones-message {
        text-align: center;
        padding: 2rem;
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        color: #856404;
    }

    .no-timezones-message a {
        color: #004085;
        font-weight: 600;
        text-decoration: none;
    }

    .no-timezones-message a:hover {
        text-decoration: underline;
    }

    /* Grid Display */
    .timezone-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .timezone-card {
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .timezone-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .timezone-card.highlight-working {
        background-color: #cfe2ff;
        border-color: #0d6efd;
    }

    .timezone-card.highlight-outside {
        background-color: #f8d7da;
        border-color: #dc3545;
    }

    .timezone-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .timezone-header h3 {
        margin: 0;
        font-size: 1.25rem;
        color: #2c3e50;
    }

    .hours-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-working {
        background-color: #0d6efd;
        color: white;
    }

    .badge-outside {
        background-color: #dc3545;
        color: white;
    }

    .timezone-time {
        text-align: center;
    }

    .time-large {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .time-details {
        font-size: 0.95rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .time-offset {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: 500;
    }

    /* List Display */
    .timezone-table {
        display: flex;
        flex-direction: column;
        gap: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }

    .list-header {
        display: grid;
        grid-template-columns: 1.5fr 1fr 1fr 1.5fr auto;
        gap: 1rem;
        padding: 1rem;
        background-color: #f8f9fa;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 2px solid #dee2e6;
    }

    .list-row {
        display: grid;
        grid-template-columns: 1.5fr 1fr 1fr 1.5fr auto;
        gap: 1rem;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        align-items: center;
        transition: background-color 0.3s ease;
    }

    .list-row:last-child {
        border-bottom: none;
    }

    .list-row:hover {
        background-color: #f8f9fa;
    }

    .list-row.highlight-working {
        background-color: #cfe2ff;
    }

    .list-row.highlight-outside {
        background-color: #f8d7da;
    }

    .col-timezone {
        font-weight: 500;
        color: #2c3e50;
    }

    .col-time, .col-date, .col-offset, .col-status {
        color: #495057;
        font-size: 0.95rem;
    }

    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* Compact Display */
    .timezone-compact {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .compact-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        transition: all 0.3s ease;
    }

    .compact-row:hover {
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .compact-row.highlight-working {
        background-color: #cfe2ff;
        border-color: #0d6efd;
    }

    .compact-row.highlight-outside {
        background-color: #f8d7da;
        border-color: #dc3545;
    }

    .compact-tz {
        font-weight: 600;
        color: #2c3e50;
        flex: 1;
    }

    .compact-time {
        font-size: 1.1rem;
        font-weight: 600;
        color: #0d6efd;
        min-width: 100px;
        text-align: right;
    }

    .compact-status {
        font-size: 0.85rem;
        font-weight: 600;
        color: #6c757d;
        min-width: 80px;
        text-align: right;
    }

    @@media (max-width: 1024px) {
        .list-header {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .list-row {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .col-offset,
        .col-status {
            display: none;
        }
    }

    @@media (max-width: 768px) {
        .timezone-container {
            padding: 1rem;
        }

        .app-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .settings-link {
            align-self: flex-end;
        }

        .timezone-grid {
            grid-template-columns: 1fr;
        }

        .legend {
            flex-direction: column;
            gap: 0.5rem;
        }

        .list-header {
            grid-template-columns: 1fr 1fr;
        }

        .list-row {
            grid-template-columns: 1fr 1fr;
        }

        .col-date,
        .col-offset,
        .col-status {
            display: none;
        }

        .compact-row {
            flex-wrap: wrap;
        }

        .compact-tz {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .compact-time {
            flex: 1;
        }
    }
</style>

@code {
    private DateTime selectedTime;
    private bool highlightWorkingHours = false;
    private List<TimeZoneDisplayModel> timeZones = new();
    private TimeZoneService.DisplayMode displayMode;

    protected override async Task OnInitializedAsync()
    {
        await TimeZoneService.InitializeAsync();
        selectedTime = TimeZoneService.GetDefaultLondonTime();
        displayMode = TimeZoneService.GetDisplayMode();
        UpdateTimeZones();
    }

    private void OnTimeChanged(ChangeEventArgs e)
    {
        if (e.Value is string timeString && TimeSpan.TryParse(timeString, out var time))
        {
            selectedTime = new DateTime(
                selectedTime.Year,
                selectedTime.Month,
                selectedTime.Day,
                time.Hours,
                time.Minutes,
                0,
                DateTimeKind.Unspecified
            );
            UpdateTimeZones();
        }
    }

    private void UpdateTimeZones()
    {
        // Reference timezone is London (GMT Standard Time)
        displayMode = TimeZoneService.GetDisplayMode();
        timeZones = TimeZoneService.GetTimeZonesForReference(selectedTime, "GMT Standard Time");
    }

    private string GetCardClass(TimeZoneDisplayModel tz)
    {
        if (!highlightWorkingHours)
            return string.Empty;

        return tz.IsWithinWorkingHours ? "highlight-working" : "highlight-outside";
    }
}
